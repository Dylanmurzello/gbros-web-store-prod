static_resources:
  listeners:
  - name: listener_http
    address:
      socket_address:
        address: 0.0.0.0
        port_value: 80
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_http
          codec_type: AUTO
          route_config:
            name: local_route
            virtual_hosts:
            - name: local_service
              domains: ["*"]
              cors:
                allow_origin_string_match:
                - exact: "https://gbrosapp.com"
                - exact: "http://gbrosapp.com"
                - exact: "http://localhost:3001"
                - exact: "https://localhost:3001"
                allow_methods: "GET, PUT, DELETE, POST, OPTIONS"
                allow_headers: "keep-alive,user-agent,cache-control,content-type,content-transfer-encoding,x-accept-content-transfer-encoding,x-accept-response-streaming,x-user-agent,x-grpc-web,grpc-timeout,vendure-auth-token"
                allow_credentials: true
                max_age: "1728000"
              routes:
              # SECURITY FIX: 2025-09-30 - Block common exploit attempts before they hit apps üõ°Ô∏è
              # Based on actual attacks seen in logs (WordPress, PHPUnit, path traversal, etc.)
              
              # Block WebDAV methods (PROPFIND, etc.) - We're not a file server bestie
              - match:
                  prefix: "/"
                  headers:
                  - name: ":method"
                    string_match:
                      safe_regex:
                        regex: "^(PROPFIND|PROPPATCH|MKCOL|COPY|MOVE|LOCK|UNLOCK|TRACE|TRACK)$"
                direct_response:
                  status: 405
                  body:
                    inline_string: "Method Not Allowed - We don't do WebDAV here"
              
              # Block .git folder access attempts
              - match:
                  safe_regex:
                    regex: "^/\\.git(/.*)?$"
                direct_response:
                  status: 403
                  body:
                    inline_string: "Forbidden - Nice try script kiddie üíÄ"
              
              # Block .env file access attempts  
              - match:
                  safe_regex:
                    regex: "^/\\.env.*$"
                direct_response:
                  status: 403
                  body:
                    inline_string: "Forbidden"
              
              # Block WordPress admin attempts (lines 56, 1007-1008 in your logs)
              - match:
                  safe_regex:
                    regex: "^/(wp-admin|wordpress)(/.*)?$"
                direct_response:
                  status: 404
                  body:
                    inline_string: "Not Found - No WordPress here bestie"
              
              # Block PHPUnit RCE exploit attempts (lines 26-38 in your logs)
              - match:
                  safe_regex:
                    regex: ".*(phpunit|eval-stdin\\.php).*"
                direct_response:
                  status: 404
                  body:
                    inline_string: "Not Found"
              
              # Block path traversal attacks (line 22-23)
              - match:
                  safe_regex:
                    regex: ".*(\\.\\.%2[fF]|\\.\\./|%2e%2e|cgi-bin).*"
                direct_response:
                  status: 403
                  body:
                    inline_string: "Forbidden - Path traversal detected"
              
              # Block common PHP exploit attempts
              - match:
                  safe_regex:
                    regex: ".*(phpMyAdmin|phpmyadmin|pma|mysql).*"
                direct_response:
                  status: 404
                  body:
                    inline_string: "Not Found"
              
              # Block suspicious query parameters (PHP code injection attempts)
              - match:
                  safe_regex:
                    regex: ".*(%ADd|allow_url_include|auto_prepend_file|php://input).*"
                direct_response:
                  status: 403
                  body:
                    inline_string: "Forbidden - Nice try with the PHP injection"
              
              # Block common admin panel discovery
              - match:
                  safe_regex:
                    regex: "^/(admin\\.php|administrator|manager|cpanel)$"
                direct_response:
                  status: 404
                  body:
                    inline_string: "Not Found"
              
              # Block backup file scanning
              - match:
                  safe_regex:
                    regex: ".*\\.(bak|backup|old|swp|~|sql|tar\\.gz|zip)$"
                direct_response:
                  status: 404
                  body:
                    inline_string: "Not Found"
              
              # Redirect HTTP to HTTPS
              - match:
                  prefix: "/"
                redirect:
                  https_redirect: true
                  strip_query: false
              # Admin API routes
              - match:
                  prefix: "/admin-api"
                route:
                  cluster: vendure_backend
                  timeout: 30s
              # Admin UI routes
              - match:
                  prefix: "/admin"
                route:
                  cluster: vendure_admin_ui
                  timeout: 30s
              # Shop API routes
              - match:
                  prefix: "/shop-api"
                route:
                  cluster: vendure_backend
                  timeout: 30s
                request_headers_to_add:
                - header:
                    key: "X-Forwarded-Host"
                    value: "%REQ(Host)%"
                  append: false
                - header:
                    key: "X-Forwarded-Proto"
                    value: "https"
                  append: false
              # Assets and static files from backend
              - match:
                  prefix: "/assets"
                route:
                  cluster: vendure_backend
                  timeout: 30s
              # Health check endpoint
              - match:
                  prefix: "/health"
                route:
                  cluster: vendure_backend
                  timeout: 5s
              # Frontend routes (catch-all)
              - match:
                  prefix: "/"
                route:
                  cluster: nextjs_frontend
                  timeout: 30s
          http_filters:
          - name: envoy.filters.http.cors
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.cors.v3.Cors
          # SECURITY FIX: 2025-10-01 - Rate limiting to prevent brute force & DDoS üö´
          - name: envoy.filters.http.local_ratelimit
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
              stat_prefix: http_local_rate_limiter
              token_bucket:
                max_tokens: 100
                tokens_per_fill: 100
                fill_interval: 60s
              filter_enabled:
                runtime_key: local_rate_limit_enabled
                default_value:
                  numerator: 100
                  denominator: HUNDRED
              filter_enforced:
                runtime_key: local_rate_limit_enforced
                default_value:
                  numerator: 100
                  denominator: HUNDRED
              response_headers_to_add:
                - append: false
                  header:
                    key: x-local-rate-limit
                    value: 'true'
          - name: envoy.filters.http.router
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
          access_log:
          - name: envoy.access_loggers.stdout
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog

  # HTTPS Listener (port 443)
  - name: listener_https
    address:
      socket_address:
        address: 0.0.0.0
        port_value: 443
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_https
          codec_type: AUTO
          route_config:
            name: local_route_https
            virtual_hosts:
            - name: local_service_https
              domains: ["*"]
              cors:
                allow_origin_string_match:
                - exact: "https://gbrosapp.com"
                - exact: "http://gbrosapp.com"
                - exact: "http://localhost:3001"
                - exact: "https://localhost:3001"
                allow_methods: "GET, PUT, DELETE, POST, OPTIONS"
                allow_headers: "keep-alive,user-agent,cache-control,content-type,content-transfer-encoding,x-accept-content-transfer-encoding,x-accept-response-streaming,x-user-agent,x-grpc-web,grpc-timeout,vendure-auth-token"
                allow_credentials: true
                max_age: "1728000"
              routes:
              # SECURITY FIX: 2025-09-30 - Same exploit blocking for HTTPS traffic üîí
              # Block WebDAV methods
              - match:
                  headers:
                  - name: ":method"
                    string_match:
                      safe_regex:
                        regex: "^(PROPFIND|PROPPATCH|MKCOL|COPY|MOVE|LOCK|UNLOCK|TRACE|TRACK)$"
                direct_response:
                  status: 405
                  body:
                    inline_string: "Method Not Allowed"
              
              # Block .git folder access
              - match:
                  safe_regex:
                    regex: "^/\\.git(/.*)?$"
                direct_response:
                  status: 403
                  body:
                    inline_string: "Forbidden"
              # Block .env files
              - match:
                  safe_regex:
                    regex: "^/\\.env.*$"
                direct_response:
                  status: 403
              # Block WordPress
              - match:
                  safe_regex:
                    regex: "^/(wp-admin|wordpress)(/.*)?$"
                direct_response:
                  status: 404
              # Block PHPUnit exploits
              - match:
                  safe_regex:
                    regex: ".*(phpunit|eval-stdin\\.php).*"
                direct_response:
                  status: 404
              # Block path traversal
              - match:
                  safe_regex:
                    regex: ".*(\\.\\.%2[fF]|\\.\\./|%2e%2e|cgi-bin).*"
                direct_response:
                  status: 403
              # Block PHP admin panels
              - match:
                  safe_regex:
                    regex: ".*(phpMyAdmin|phpmyadmin|pma|mysql).*"
                direct_response:
                  status: 404
              # Block PHP injection params
              - match:
                  safe_regex:
                    regex: ".*(%ADd|allow_url_include|auto_prepend_file|php://input).*"
                direct_response:
                  status: 403
              # Block admin discovery
              - match:
                  safe_regex:
                    regex: "^/(admin\\.php|administrator|manager|cpanel)$"
                direct_response:
                  status: 404
              # Block backup files
              - match:
                  safe_regex:
                    regex: ".*\\.(bak|backup|old|swp|~|sql|tar\\.gz|zip)$"
                direct_response:
                  status: 404
              
              # Admin API routes
              - match:
                  prefix: "/admin-api"
                route:
                  cluster: vendure_backend
                  timeout: 30s
              # Admin UI routes
              - match:
                  prefix: "/admin"
                route:
                  cluster: vendure_admin_ui
                  timeout: 30s
              # Shop API routes
              - match:
                  prefix: "/shop-api"
                route:
                  cluster: vendure_backend
                  timeout: 30s
                request_headers_to_add:
                - header:
                    key: "X-Forwarded-Host"
                    value: "%REQ(Host)%"
                  append: false
                - header:
                    key: "X-Forwarded-Proto"
                    value: "https"
                  append: false
              # Assets and static files from backend
              - match:
                  prefix: "/assets"
                route:
                  cluster: vendure_backend
                  timeout: 30s
              # Health check endpoint
              - match:
                  prefix: "/health"
                route:
                  cluster: vendure_backend
                  timeout: 5s
              # Frontend routes (catch-all)
              - match:
                  prefix: "/"
                route:
                  cluster: nextjs_frontend
                  timeout: 30s
          http_filters:
          - name: envoy.filters.http.cors
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.cors.v3.Cors
          # SECURITY FIX: 2025-10-01 - Rate limiting to prevent brute force & DDoS üö´
          - name: envoy.filters.http.local_ratelimit
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
              stat_prefix: http_local_rate_limiter
              token_bucket:
                max_tokens: 100
                tokens_per_fill: 100
                fill_interval: 60s
              filter_enabled:
                runtime_key: local_rate_limit_enabled
                default_value:
                  numerator: 100
                  denominator: HUNDRED
              filter_enforced:
                runtime_key: local_rate_limit_enforced
                default_value:
                  numerator: 100
                  denominator: HUNDRED
              response_headers_to_add:
                - append: false
                  header:
                    key: x-local-rate-limit
                    value: 'true'
          - name: envoy.filters.http.router
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
          access_log:
          - name: envoy.access_loggers.stdout
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog
      transport_socket:
        name: envoy.transport_sockets.tls
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext
          common_tls_context:
            tls_certificates:
            - certificate_chain:
                filename: "/opt/ssl/fullchain.pem"
              private_key:
                filename: "/opt/ssl/privkey.pem"

  clusters:
  # Next.js Frontend cluster
  - name: nextjs_frontend
    connect_timeout: 5s
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: nextjs_frontend
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: host.docker.internal
                port_value: 3001

  # Vendure Backend cluster
  - name: vendure_backend
    connect_timeout: 5s
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: vendure_backend
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: host.docker.internal
                port_value: 3000

  # Vendure Admin UI cluster (served by backend on same port)
  - name: vendure_admin_ui
    connect_timeout: 5s
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: vendure_admin_ui
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: host.docker.internal
                port_value: 3000

admin:
  address:
    socket_address:
      address: 0.0.0.0
      port_value: 9901
  access_log_path: /tmp/admin_access.log
