static_resources:
  listeners:
  - name: listener_http
    address:
      socket_address:
        address: 0.0.0.0
        port_value: 80
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_http
          codec_type: AUTO
          route_config:
            name: local_route
            virtual_hosts:
            - name: local_service
              domains: ["*"]
              cors:
                allow_origin_string_match:
                - exact: "https://gbrosapp.com"
                - exact: "http://gbrosapp.com"
                - exact: "http://localhost:3001"
                - exact: "https://localhost:3001"
                allow_methods: "GET, PUT, DELETE, POST, OPTIONS"
                allow_headers: "keep-alive,user-agent,cache-control,content-type,content-transfer-encoding,x-accept-content-transfer-encoding,x-accept-response-streaming,x-user-agent,x-grpc-web,grpc-timeout,vendure-auth-token"
                allow_credentials: true
                max_age: "1728000"
              # SECURITY FIX: 2025-10-04 - Security headers for all HTTP responses üîí
              response_headers_to_add:
              - header:
                  key: "X-Frame-Options"
                  value: "SAMEORIGIN"
                append_action: OVERWRITE_IF_EXISTS_OR_ADD
              - header:
                  key: "X-Content-Type-Options"
                  value: "nosniff"
                append_action: OVERWRITE_IF_EXISTS_OR_ADD
              - header:
                  key: "X-XSS-Protection"
                  value: "1; mode=block"
                append_action: OVERWRITE_IF_EXISTS_OR_ADD
              - header:
                  key: "Referrer-Policy"
                  value: "strict-origin-when-cross-origin"
                append_action: OVERWRITE_IF_EXISTS_OR_ADD
              - header:
                  key: "Permissions-Policy"
                  value: "geolocation=(), microphone=(), camera=(), payment=(self)"
                append_action: OVERWRITE_IF_EXISTS_OR_ADD
              - header:
                  key: "Content-Security-Policy"
                  value: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.gbrosapp.com https://*.google.com https://*.googleapis.com https://accounts.google.com https://js.squareup.com https://web.squarecdn.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https: blob:; font-src 'self' data: https://fonts.gstatic.com; connect-src 'self' https://cdn.gbrosapp.com https://*.google.com https://*.googleapis.com https://web.squarecdn.com; frame-src 'self' https://*.google.com https://js.squareup.com; object-src 'none'; base-uri 'self'; form-action 'self';"
                append_action: OVERWRITE_IF_EXISTS_OR_ADD
              routes:
              # SECURITY FIX: 2025-09-30 - Block common exploit attempts before they hit apps üõ°Ô∏è
              # Based on actual attacks seen in logs (WordPress, PHPUnit, path traversal, etc.)
              
              # Block WebDAV methods (PROPFIND, etc.) - We're not a file server bestie
              - match:
                  prefix: "/"
                  headers:
                  - name: ":method"
                    string_match:
                      safe_regex:
                        regex: "^(PROPFIND|PROPPATCH|MKCOL|COPY|MOVE|LOCK|UNLOCK|TRACE|TRACK)$"
                direct_response:
                  status: 405
                  body:
                    inline_string: "Method Not Allowed - We don't do WebDAV here"
              
              # Block .git folder access attempts
              - match:
                  safe_regex:
                    regex: "^/\\.git(/.*)?$"
                direct_response:
                  status: 403
                  body:
                    inline_string: "Forbidden - Nice try script kiddie üíÄ"
              
              # Block .env file access attempts  
              - match:
                  safe_regex:
                    regex: "^/\\.env.*$"
                direct_response:
                  status: 403
                  body:
                    inline_string: "Forbidden"
              
              # Block WordPress admin attempts (lines 56, 1007-1008 in your logs)
              - match:
                  safe_regex:
                    regex: "^/(wp-admin|wordpress)(/.*)?$"
                direct_response:
                  status: 404
                  body:
                    inline_string: "Not Found - No WordPress here bestie"
              
              # Block PHPUnit RCE exploit attempts (lines 26-38 in your logs)
              - match:
                  safe_regex:
                    regex: ".*(phpunit|eval-stdin\\.php).*"
                direct_response:
                  status: 404
                  body:
                    inline_string: "Not Found"
              
              # Block path traversal attacks (line 22-23)
              - match:
                  safe_regex:
                    regex: ".*(\\.\\.%2[fF]|\\.\\./|%2e%2e|cgi-bin).*"
                direct_response:
                  status: 403
                  body:
                    inline_string: "Forbidden - Path traversal detected"
              
              # Block common PHP exploit attempts
              - match:
                  safe_regex:
                    regex: ".*(phpMyAdmin|phpmyadmin|pma|mysql).*"
                direct_response:
                  status: 404
                  body:
                    inline_string: "Not Found"
              
              # Block suspicious query parameters (PHP code injection attempts)
              - match:
                  safe_regex:
                    regex: ".*(%ADd|allow_url_include|auto_prepend_file|php://input).*"
                direct_response:
                  status: 403
                  body:
                    inline_string: "Forbidden - Nice try with the PHP injection"
              
              # Block common admin panel discovery
              - match:
                  safe_regex:
                    regex: "^/(admin\\.php|administrator|manager|cpanel)$"
                direct_response:
                  status: 404
                  body:
                    inline_string: "Not Found"
              
              # Block backup file scanning
              - match:
                  safe_regex:
                    regex: ".*\\.(bak|backup|old|swp|~|sql|tar\\.gz|zip)$"
                direct_response:
                  status: 404
                  body:
                    inline_string: "Not Found"
              
              # Redirect HTTP to HTTPS
              - match:
                  prefix: "/"
                redirect:
                  https_redirect: true
                  strip_query: false
              # Admin API routes
              - match:
                  prefix: "/admin-api"
                route:
                  cluster: vendure_backend
                  timeout: 30s
              # Admin UI routes
              - match:
                  prefix: "/admin"
                route:
                  cluster: vendure_admin_ui
                  timeout: 30s
              # Shop API routes
              - match:
                  prefix: "/shop-api"
                route:
                  cluster: vendure_backend
                  timeout: 30s
                request_headers_to_add:
                - header:
                    key: "X-Forwarded-Host"
                    value: "%REQ(Host)%"
                  append: false
                - header:
                    key: "X-Forwarded-Proto"
                    value: "https"
                  append: false
              # Assets and static files from backend
              - match:
                  prefix: "/assets"
                route:
                  cluster: vendure_backend
                  timeout: 30s
              # Health check endpoint
              - match:
                  prefix: "/health"
                route:
                  cluster: vendure_backend
                  timeout: 5s
              # Frontend routes (catch-all)
              - match:
                  prefix: "/"
                route:
                  cluster: nextjs_frontend
                  timeout: 30s
          http_filters:
          - name: envoy.filters.http.cors
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.cors.v3.Cors
          # SECURITY FIX: 2025-10-01 - Rate limiting to prevent brute force & DDoS üö´
          - name: envoy.filters.http.local_ratelimit
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
              stat_prefix: http_local_rate_limiter
              token_bucket:
                max_tokens: 100
                tokens_per_fill: 100
                fill_interval: 60s
              filter_enabled:
                runtime_key: local_rate_limit_enabled
                default_value:
                  numerator: 100
                  denominator: HUNDRED
              filter_enforced:
                runtime_key: local_rate_limit_enforced
                default_value:
                  numerator: 100
                  denominator: HUNDRED
              response_headers_to_add:
                - append: false
                  header:
                    key: x-local-rate-limit
                    value: 'true'
          - name: envoy.filters.http.router
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
          access_log:
          - name: envoy.access_loggers.stdout
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog

  # HTTPS Listener (port 443)
  - name: listener_https
    address:
      socket_address:
        address: 0.0.0.0
        port_value: 443
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_https
          codec_type: AUTO
          # PERFORMANCE FIX: 2025-10-04 - Enable HTTP/2 for faster multiplexed connections üöÄ
          http2_protocol_options:
            max_concurrent_streams: 128
            initial_stream_window_size: 65536
            initial_connection_window_size: 1048576
          route_config:
            name: local_route_https
            virtual_hosts:
            - name: local_service_https
              domains: ["*"]
              cors:
                allow_origin_string_match:
                - exact: "https://gbrosapp.com"
                - exact: "http://gbrosapp.com"
                - exact: "http://localhost:3001"
                - exact: "https://localhost:3001"
                allow_methods: "GET, PUT, DELETE, POST, OPTIONS"
                allow_headers: "keep-alive,user-agent,cache-control,content-type,content-transfer-encoding,x-accept-content-transfer-encoding,x-accept-response-streaming,x-user-agent,x-grpc-web,grpc-timeout,vendure-auth-token"
                allow_credentials: true
                max_age: "1728000"
              # SECURITY FIX: 2025-10-04 - Security headers for all HTTPS responses üîí
              response_headers_to_add:
              - header:
                  key: "Strict-Transport-Security"
                  value: "max-age=31536000; includeSubDomains; preload"
                append_action: OVERWRITE_IF_EXISTS_OR_ADD
              - header:
                  key: "X-Frame-Options"
                  value: "SAMEORIGIN"
                append_action: OVERWRITE_IF_EXISTS_OR_ADD
              - header:
                  key: "X-Content-Type-Options"
                  value: "nosniff"
                append_action: OVERWRITE_IF_EXISTS_OR_ADD
              - header:
                  key: "X-XSS-Protection"
                  value: "1; mode=block"
                append_action: OVERWRITE_IF_EXISTS_OR_ADD
              - header:
                  key: "Referrer-Policy"
                  value: "strict-origin-when-cross-origin"
                append_action: OVERWRITE_IF_EXISTS_OR_ADD
              - header:
                  key: "Permissions-Policy"
                  value: "geolocation=(), microphone=(), camera=(), payment=(self)"
                append_action: OVERWRITE_IF_EXISTS_OR_ADD
              - header:
                  key: "Content-Security-Policy"
                  value: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.gbrosapp.com https://*.google.com https://*.googleapis.com https://accounts.google.com https://js.squareup.com https://web.squarecdn.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https: blob:; font-src 'self' data: https://fonts.gstatic.com; connect-src 'self' https://cdn.gbrosapp.com https://*.google.com https://*.googleapis.com https://web.squarecdn.com; frame-src 'self' https://*.google.com https://js.squareup.com; object-src 'none'; base-uri 'self'; form-action 'self';"
                append_action: OVERWRITE_IF_EXISTS_OR_ADD
              routes:
              # SECURITY FIX: 2025-09-30 - Same exploit blocking for HTTPS traffic üîí
              # Block WebDAV methods
              - match:
                  prefix: "/"
                  headers:
                  - name: ":method"
                    string_match:
                      safe_regex:
                        regex: "^(PROPFIND|PROPPATCH|MKCOL|COPY|MOVE|LOCK|UNLOCK|TRACE|TRACK)$"
                direct_response:
                  status: 405
                  body:
                    inline_string: "Method Not Allowed"
              
              # Block .git folder access
              - match:
                  safe_regex:
                    regex: "^/\\.git(/.*)?$"
                direct_response:
                  status: 403
                  body:
                    inline_string: "Forbidden"
              # Block .env files
              - match:
                  safe_regex:
                    regex: "^/\\.env.*$"
                direct_response:
                  status: 403
              # Block WordPress
              - match:
                  safe_regex:
                    regex: "^/(wp-admin|wordpress)(/.*)?$"
                direct_response:
                  status: 404
              # Block PHPUnit exploits
              - match:
                  safe_regex:
                    regex: ".*(phpunit|eval-stdin\\.php).*"
                direct_response:
                  status: 404
              # Block path traversal
              - match:
                  safe_regex:
                    regex: ".*(\\.\\.%2[fF]|\\.\\./|%2e%2e|cgi-bin).*"
                direct_response:
                  status: 403
              # Block PHP admin panels
              - match:
                  safe_regex:
                    regex: ".*(phpMyAdmin|phpmyadmin|pma|mysql).*"
                direct_response:
                  status: 404
              # Block PHP injection params
              - match:
                  safe_regex:
                    regex: ".*(%ADd|allow_url_include|auto_prepend_file|php://input).*"
                direct_response:
                  status: 403
              # Block admin discovery
              - match:
                  safe_regex:
                    regex: "^/(admin\\.php|administrator|manager|cpanel)$"
                direct_response:
                  status: 404
              # Block backup files
              - match:
                  safe_regex:
                    regex: ".*\\.(bak|backup|old|swp|~|sql|tar\\.gz|zip)$"
                direct_response:
                  status: 404
              
              # RATE LIMITING FIX: 2025-10-02 - Per-route rate limiting so static assets don't get throttled üéØ
              # Modern web apps make TONS of requests (Next.js chunks, images, etc) - we gotta be smart about limits
              
              # Next.js static assets - NO RATE LIMITING (these are just files bestie)
              - match:
                  prefix: "/_next/static/"
                route:
                  cluster: nextjs_frontend
                  timeout: 30s
                typed_per_filter_config:
                  envoy.filters.http.local_ratelimit:
                    "@type": type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
                    stat_prefix: static_assets_no_limit
                    token_bucket:
                      max_tokens: 100000
                      tokens_per_fill: 100000
                      fill_interval: 60s
                    filter_enabled:
                      default_value:
                        numerator: 0
                        denominator: HUNDRED
              
              # Next.js image optimization - NO RATE LIMITING 
              - match:
                  prefix: "/_next/image"
                route:
                  cluster: nextjs_frontend
                  timeout: 30s
                typed_per_filter_config:
                  envoy.filters.http.local_ratelimit:
                    "@type": type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
                    stat_prefix: images_no_limit
                    token_bucket:
                      max_tokens: 100000
                      tokens_per_fill: 100000
                      fill_interval: 60s
                    filter_enabled:
                      default_value:
                        numerator: 0
                        denominator: HUNDRED
              
              # Next.js dev tools - NO RATE LIMITING (but should block in prod later)
              - match:
                  prefix: "/__nextjs"
                route:
                  cluster: nextjs_frontend
                  timeout: 30s
                typed_per_filter_config:
                  envoy.filters.http.local_ratelimit:
                    "@type": type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
                    stat_prefix: nextjs_dev_no_limit
                    token_bucket:
                      max_tokens: 100000
                      tokens_per_fill: 100000
                      fill_interval: 60s
                    filter_enabled:
                      default_value:
                        numerator: 0
                        denominator: HUNDRED
              
              # Static images - NO RATE LIMITING
              - match:
                  prefix: "/images/"
                route:
                  cluster: nextjs_frontend
                  timeout: 30s
                typed_per_filter_config:
                  envoy.filters.http.local_ratelimit:
                    "@type": type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
                    stat_prefix: static_images_no_limit
                    token_bucket:
                      max_tokens: 100000
                      tokens_per_fill: 100000
                      fill_interval: 60s
                    filter_enabled:
                      default_value:
                        numerator: 0
                        denominator: HUNDRED
              
              # Favicon - NO RATE LIMITING (browsers spam this constantly lmao)
              - match:
                  prefix: "/favicon.ico"
                route:
                  cluster: nextjs_frontend
                  timeout: 5s
                typed_per_filter_config:
                  envoy.filters.http.local_ratelimit:
                    "@type": type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
                    stat_prefix: favicon_no_limit
                    token_bucket:
                      max_tokens: 100000
                      tokens_per_fill: 100000
                      fill_interval: 60s
                    filter_enabled:
                      default_value:
                        numerator: 0
                        denominator: HUNDRED
              
              # Admin API routes - LOOSE LIMIT (500/min, let Vendure HardenPlugin handle the real throttling)
              - match:
                  prefix: "/admin-api"
                route:
                  cluster: vendure_backend
                  timeout: 30s
                typed_per_filter_config:
                  envoy.filters.http.local_ratelimit:
                    "@type": type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
                    stat_prefix: admin_api_rate_limiter
                    token_bucket:
                      max_tokens: 500
                      tokens_per_fill: 500
                      fill_interval: 60s
                    filter_enabled:
                      default_value:
                        numerator: 100
                        denominator: HUNDRED
                    filter_enforced:
                      default_value:
                        numerator: 100
                        denominator: HUNDRED
              
              # Admin UI routes - MEDIUM LIMIT (200/min for authenticated admin users)
              - match:
                  prefix: "/admin"
                route:
                  cluster: vendure_admin_ui
                  timeout: 30s
                typed_per_filter_config:
                  envoy.filters.http.local_ratelimit:
                    "@type": type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
                    stat_prefix: admin_ui_rate_limiter
                    token_bucket:
                      max_tokens: 200
                      tokens_per_fill: 200
                      fill_interval: 60s
                    filter_enabled:
                      default_value:
                        numerator: 100
                        denominator: HUNDRED
                    filter_enforced:
                      default_value:
                        numerator: 100
                        denominator: HUNDRED
              
              # Shop API routes - LOOSE LIMIT (500/min, Vendure HardenPlugin does smart throttling based on query complexity)
              - match:
                  prefix: "/shop-api"
                route:
                  cluster: vendure_backend
                  timeout: 30s
                request_headers_to_add:
                - header:
                    key: "X-Forwarded-Host"
                    value: "%REQ(Host)%"
                  append: false
                - header:
                    key: "X-Forwarded-Proto"
                    value: "https"
                  append: false
                typed_per_filter_config:
                  envoy.filters.http.local_ratelimit:
                    "@type": type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
                    stat_prefix: shop_api_rate_limiter
                    token_bucket:
                      max_tokens: 500
                      tokens_per_fill: 500
                      fill_interval: 60s
                    filter_enabled:
                      default_value:
                        numerator: 100
                        denominator: HUNDRED
                    filter_enforced:
                      default_value:
                        numerator: 100
                        denominator: HUNDRED
              
              # Assets and static files from backend - NO RATE LIMITING (CDN images/files)
              - match:
                  prefix: "/assets"
                route:
                  cluster: vendure_backend
                  timeout: 30s
                typed_per_filter_config:
                  envoy.filters.http.local_ratelimit:
                    "@type": type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
                    stat_prefix: backend_assets_no_limit
                    token_bucket:
                      max_tokens: 100000
                      tokens_per_fill: 100000
                      fill_interval: 60s
                    filter_enabled:
                      default_value:
                        numerator: 0
                        denominator: HUNDRED
              
              # Health check endpoint - LOOSE LIMIT (1000/min, monitoring systems hit this frequently)
              - match:
                  prefix: "/health"
                route:
                  cluster: vendure_backend
                  timeout: 5s
                typed_per_filter_config:
                  envoy.filters.http.local_ratelimit:
                    "@type": type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
                    stat_prefix: health_check_rate_limiter
                    token_bucket:
                      max_tokens: 1000
                      tokens_per_fill: 1000
                      fill_interval: 60s
                    filter_enabled:
                      default_value:
                        numerator: 100
                        denominator: HUNDRED
                    filter_enforced:
                      default_value:
                        numerator: 100
                        denominator: HUNDRED
              
              # Frontend routes (catch-all) - MEDIUM LIMIT (200/min for page loads, prevents spam but allows normal browsing)
              - match:
                  prefix: "/"
                route:
                  cluster: nextjs_frontend
                  timeout: 30s
                typed_per_filter_config:
                  envoy.filters.http.local_ratelimit:
                    "@type": type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
                    stat_prefix: frontend_pages_rate_limiter
                    token_bucket:
                      max_tokens: 200
                      tokens_per_fill: 200
                      fill_interval: 60s
                    filter_enabled:
                      default_value:
                        numerator: 100
                        denominator: HUNDRED
                    filter_enforced:
                      default_value:
                        numerator: 100
                        denominator: HUNDRED
          http_filters:
          - name: envoy.filters.http.cors
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.cors.v3.Cors
          # SECURITY FIX: 2025-10-01 - Rate limiting to prevent brute force & DDoS üö´
          - name: envoy.filters.http.local_ratelimit
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
              stat_prefix: http_local_rate_limiter
              token_bucket:
                max_tokens: 100
                tokens_per_fill: 100
                fill_interval: 60s
              filter_enabled:
                runtime_key: local_rate_limit_enabled
                default_value:
                  numerator: 100
                  denominator: HUNDRED
              filter_enforced:
                runtime_key: local_rate_limit_enforced
                default_value:
                  numerator: 100
                  denominator: HUNDRED
              response_headers_to_add:
                - append: false
                  header:
                    key: x-local-rate-limit
                    value: 'true'
          - name: envoy.filters.http.router
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
          access_log:
          - name: envoy.access_loggers.stdout
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog
      transport_socket:
        name: envoy.transport_sockets.tls
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext
          common_tls_context:
            # PERFORMANCE FIX: 2025-10-04 - ALPN for HTTP/2 negotiation üöÄ
            alpn_protocols:
            - h2          # HTTP/2
            - http/1.1    # HTTP/1.1 fallback
            tls_certificates:
            - certificate_chain:
                filename: "/opt/ssl/fullchain.pem"
              private_key:
                filename: "/opt/ssl/privkey.pem"

  clusters:
  # Next.js Frontend cluster
  - name: nextjs_frontend
    connect_timeout: 5s
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: nextjs_frontend
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: host.docker.internal
                port_value: 3001

  # Vendure Backend cluster
  - name: vendure_backend
    connect_timeout: 5s
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: vendure_backend
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: host.docker.internal
                port_value: 3000

  # Vendure Admin UI cluster (served by backend on same port)
  - name: vendure_admin_ui
    connect_timeout: 5s
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: vendure_admin_ui
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: host.docker.internal
                port_value: 3000

admin:
  address:
    socket_address:
      address: 0.0.0.0
      port_value: 9901
  access_log_path: /tmp/admin_access.log
